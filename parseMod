#!/usr/bin/env python

# Parse /var/log/messages files and count
# what modules were called 
# As an arguetn provide files(s) path.
# Without an argument all /var/log/messages* files are processed

from collections import defaultdict
import sys
import os

class  FileParser:
    def __init__(self, args):
        self.args = args[1:]          # command ine arguments
        self.basedir = "/var/log/"    # default drectory for system messages files
        self.files = []               # file names to parse

        self.parseArgs()

    def exitError(self):
        print self.errmsg
        sys.exit(1)

    def parseArgs(self):
        if self.args == []:
            self.getDefaultFiles()
        else:
            for i in self.args:
                if os.path.isfile(i):
                    self.files.append(i)

    def getDefaultFiles(self):
            try:
                all = os.listdir(self.basedir)
            except OSError as err:
                self.errmsg = "Error code %d: %s: '%s'" % (err.errno, err.strerror, err.filename)
                self.exitError()

            for i in all:
                if i.find("messages") == 0:
                    self.files.append(self.basedir + i)

    def getModuleLines(self):
        self.maxl = 0 
        output = defaultdict(int)
        for log in self.files:
            f =  open(log) 
            for i, line in enumerate(f):
                if line.find("module-hpc:") < 0: continue
                module = line.split()[-1]
                # dictionary key:value is {modulename: number_of_times_called}
                output[module] += 1
                ll = len(module)
                if ll > self.maxl:
                    self.maxl = ll

        # to get only entries with more than 1 count
        # self.entries = {k: v for k, v in output.items() if v > 1}

        self.entries = output # get all entries
        self.entriesTotal = len(self.entries)

    def printAnswer(self):
        self.getModuleLines()
        sortedEnries = sorted(self.entries.items(), key=lambda x: x[1], reverse=True)

        for i in sortedEnries:
            print '{sw:{width}s} {num:12d}'.format(sw=i[0], num=i[1], width=self.maxl)
        print "\nTotal different modules used:", self.entriesTotal


    def run(self):
        self.printAnswer()

app = FileParser(sys.argv)
app.run()

